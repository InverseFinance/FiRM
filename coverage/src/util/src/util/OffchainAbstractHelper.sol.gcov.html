<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - filtered-lcov.info - src/util/src/util/OffchainAbstractHelper.sol</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

          <table width="100%" border=0 cellspacing=0 cellpadding=0>
            <tr><td class="title">LCOV - code coverage report</td></tr>
            <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

            <tr>
              <td width="100%">
                <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="10%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">src/util/src/util</a> - OffchainAbstractHelper.sol<span style="font-size: 80%;"> (source / <a href="OffchainAbstractHelper.sol.func-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="5%"></td>
            <td width="5%" class="headerCovTableHead">Coverage</td>
            <td width="5%" class="headerCovTableHead" title="Covered + Uncovered code">Total</td>
            <td width="5%" class="headerCovTableHead" title="Exercised code only">Hit</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">filtered-lcov.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntryHi">94.4&nbsp;%</td>
            <td class="headerCovTableEntry">54</td>
            <td class="headerCovTableEntry">51</td>
          </tr>
          <tr>
            <td class="headerItem">Test Date:</td>
            <td class="headerValue">2023-10-25 16:38:22</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntryHi">100.0&nbsp;%</td>
            <td class="headerCovTableEntry">10</td>
            <td class="headerCovTableEntry">10</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntryLo">42.9&nbsp;%</td>
            <td class="headerCovTableEntry">14</td>
            <td class="headerCovTableEntry">6</td>
          </tr>
                  <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
                </table>
              </td>
            </tr>

            <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
          </table>

          <table cellpadding=0 cellspacing=0 border=0>
            <tr>
              <td><br></td>
            </tr>
            <tr>
              <td>
<pre class="sourceHeading">             Branch data     Line data    Source code</pre>
<pre class="source">
<span id="L1"><span class="lineNum">       1</span>                 :             : pragma solidity ^0.8.13;</span>
<span id="L2"><span class="lineNum">       2</span>                 :             : import &quot;../interfaces/IMarket.sol&quot;;</span>
<span id="L3"><span class="lineNum">       3</span>                 :             : interface IERC20 {</span>
<span id="L4"><span class="lineNum">       4</span>                 :             :     function transfer(address to, uint amount) external;</span>
<span id="L5"><span class="lineNum">       5</span>                 :             :     function transferFrom(address from, address to, uint amount) external;</span>
<span id="L6"><span class="lineNum">       6</span>                 :             :     function approve(address to, uint amount) external;</span>
<span id="L7"><span class="lineNum">       7</span>                 :             :     function balanceOf(address user) external view returns(uint);</span>
<span id="L8"><span class="lineNum">       8</span>                 :             : }</span>
<span id="L9"><span class="lineNum">       9</span>                 :             : </span>
<span id="L10"><span class="lineNum">      10</span>                 :             : interface IWETH is IERC20 {</span>
<span id="L11"><span class="lineNum">      11</span>                 :             :     function withdraw(uint wad) external;</span>
<span id="L12"><span class="lineNum">      12</span>                 :             :     function deposit() external payable;</span>
<span id="L13"><span class="lineNum">      13</span>                 :             : }</span>
<span id="L14"><span class="lineNum">      14</span>                 :             : </span>
<span id="L15"><span class="lineNum">      15</span>                 :             : abstract contract OffchainAbstractHelper {</span>
<span id="L16"><span class="lineNum">      16</span>                 :             : </span>
<span id="L17"><span class="lineNum">      17</span>                 :             :     IERC20 constant DOLA = IERC20(0x865377367054516e17014CcdED1e7d814EDC9ce4);</span>
<span id="L18"><span class="lineNum">      18</span>                 :             :     IERC20 constant DBR = IERC20(0xAD038Eb671c44b853887A7E32528FaB35dC5D710);</span>
<span id="L19"><span class="lineNum">      19</span>                 :             :     IWETH constant WETH = IWETH(0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2);</span>
<span id="L20"><span class="lineNum">      20</span>                 :             :     </span>
<span id="L21"><span class="lineNum">      21</span>                 :             :     /**</span>
<span id="L22"><span class="lineNum">      22</span>                 :             :     Virtual functions implemented by the AMM interfacing part of the Helper contract</span>
<span id="L23"><span class="lineNum">      23</span>                 :             :     */</span>
<span id="L24"><span class="lineNum">      24</span>                 :             : </span>
<span id="L25"><span class="lineNum">      25</span>                 :             :     /**</span>
<span id="L26"><span class="lineNum">      26</span>                 :             :     @notice Buys DBR for an amount of Dola</span>
<span id="L27"><span class="lineNum">      27</span>                 :             :     @param amount Amount of Dola to spend on DBR</span>
<span id="L28"><span class="lineNum">      28</span>                 :             :     @param minOut minimum amount of DBR to receive</span>
<span id="L29"><span class="lineNum">      29</span>                 :             :     */</span>
<span id="L30"><span class="lineNum">      30</span>                 :             :     function _buyDbr(uint amount, uint minOut, address receiver) internal virtual;</span>
<span id="L31"><span class="lineNum">      31</span>                 :             : </span>
<span id="L32"><span class="lineNum">      32</span>                 :             :     /**</span>
<span id="L33"><span class="lineNum">      33</span>                 :             :     @notice Sells an exact amount of DBR for DOLA</span>
<span id="L34"><span class="lineNum">      34</span>                 :             :     @param amount Amount of DBR to sell</span>
<span id="L35"><span class="lineNum">      35</span>                 :             :     @param minOut minimum amount of DOLA to receive</span>
<span id="L36"><span class="lineNum">      36</span>                 :             :     */</span>
<span id="L37"><span class="lineNum">      37</span>                 :             :     function _sellDbr(uint amount, uint minOut) internal virtual;</span>
<span id="L38"><span class="lineNum">      38</span>                 :             : </span>
<span id="L39"><span class="lineNum">      39</span>                 :             :     /**</span>
<span id="L40"><span class="lineNum">      40</span>                 :             :     @notice Approximates the amount of additional DOLA and DBR needed to sustain dolaBorrowAmount over the period</span>
<span id="L41"><span class="lineNum">      41</span>                 :             :     @dev Larger number of iterations increases both accuracy of the approximation and gas cost. This method should not be called in smart contract code.</span>
<span id="L42"><span class="lineNum">      42</span>                 :             :     @param dolaBorrowAmount The amount of DOLA the user wishes to borrow before covering DBR expenses</span>
<span id="L43"><span class="lineNum">      43</span>                 :             :     @param minDbr The amount of seconds the user wish to borrow the DOLA for</span>
<span id="L44"><span class="lineNum">      44</span>                 :             :     @param iterations The amount of approximation iterations.</span>
<span id="L45"><span class="lineNum">      45</span>                 :             :     @return Tuple of (dolaNeeded, dbrNeeded) representing the total dola needed to pay for the DBR and pay out dolaBorrowAmount and the dbrNeeded to sustain the loan over the period</span>
<span id="L46"><span class="lineNum">      46</span>                 :             :     */</span>
<span id="L47"><span class="lineNum">      47</span>                 :             :     function approximateDolaAndDbrNeeded(uint dolaBorrowAmount, uint minDbr, uint iterations) public view virtual returns(uint, uint);</span>
<span id="L48"><span class="lineNum">      48</span>                 :             : </span>
<span id="L49"><span class="lineNum">      49</span>                 :             :     /**</span>
<span id="L50"><span class="lineNum">      50</span>                 :             :     @notice Borrows on behalf of the caller, buying the necessary DBR to pay for the loan over the period, by borrowing aditional funds to pay for the necessary DBR</span>
<span id="L51"><span class="lineNum">      51</span>                 :             :     @dev Has to borrow the dolaForDbr amount due to how the market's borrowOnBehalf functions, and repay the excess at the end of the call resulting in a weird repay event</span>
<span id="L52"><span class="lineNum">      52</span>                 :             :     @param market Market the caller wishes to borrow from</span>
<span id="L53"><span class="lineNum">      53</span>                 :             :     @param dolaAmount Amount the caller wants to end up with at their disposal</span>
<span id="L54"><span class="lineNum">      54</span>                 :             :     @param dolaForDbr The max amount of debt the caller is willing to end up with</span>
<span id="L55"><span class="lineNum">      55</span>                 :             :      This is a sensitive parameter and should be reasonably low to prevent sandwhiching.</span>
<span id="L56"><span class="lineNum">      56</span>                 :             :      A good estimate can be calculated given the approximateDolaAndDbrNeeded function, though should be set slightly higher.</span>
<span id="L57"><span class="lineNum">      57</span>                 :             :     @param minDbr The minDbr the caller wish to borrow for</span>
<span id="L58"><span class="lineNum">      58</span>                 :             :     @param deadline Deadline of the signature</span>
<span id="L59"><span class="lineNum">      59</span>                 :             :     @param v V parameter of the signature</span>
<span id="L60"><span class="lineNum">      60</span>                 :             :     @param r R parameter of the signature</span>
<span id="L61"><span class="lineNum">      61</span>                 :             :     @param s S parameter of the signature</span>
<span id="L62"><span class="lineNum">      62</span>                 :             :     */</span>
<span id="L63"><span class="lineNum">      63</span>                 :<span class="tlaGNC tlaBgGNC">           5 :     function buyDbrAndBorrowOnBehalf(</span></span>
<span id="L64"><span class="lineNum">      64</span>                 :             :         IMarket market, </span>
<span id="L65"><span class="lineNum">      65</span>                 :             :         uint dolaAmount,</span>
<span id="L66"><span class="lineNum">      66</span>                 :             :         uint dolaForDbr,</span>
<span id="L67"><span class="lineNum">      67</span>                 :             :         uint minDbr,</span>
<span id="L68"><span class="lineNum">      68</span>                 :             :         uint deadline, </span>
<span id="L69"><span class="lineNum">      69</span>                 :             :         uint8 v, </span>
<span id="L70"><span class="lineNum">      70</span>                 :             :         bytes32 r, </span>
<span id="L71"><span class="lineNum">      71</span>                 :             :         bytes32 s) </span>
<span id="L72"><span class="lineNum">      72</span>                 :             :         public </span>
<span id="L73"><span class="lineNum">      73</span>                 :             :     {</span>
<span id="L74"><span class="lineNum">      74</span>                 :             :         //Borrow Dola</span>
<span id="L75"><span class="lineNum">      75</span>                 :<span class="tlaGNC">           7 :         uint totalBorrow = dolaAmount + dolaForDbr;</span></span>
<span id="L76"><span class="lineNum">      76</span>                 :<span class="tlaGNC">           7 :         market.borrowOnBehalf(msg.sender, totalBorrow, deadline, v, r, s);</span></span>
<span id="L77"><span class="lineNum">      77</span>                 :             :         </span>
<span id="L78"><span class="lineNum">      78</span>                 :             :         //Buy DBR</span>
<span id="L79"><span class="lineNum">      79</span>                 :<span class="tlaGNC">           7 :         _buyDbr(dolaForDbr, minDbr, msg.sender);</span></span>
<span id="L80"><span class="lineNum">      80</span>                 :             : </span>
<span id="L81"><span class="lineNum">      81</span>                 :             :         //Transfer remaining DOLA amount to user</span>
<span id="L82"><span class="lineNum">      82</span>                 :<span class="tlaGNC">           7 :         DOLA.transfer(msg.sender, dolaAmount);</span></span>
<span id="L83"><span class="lineNum">      83</span>                 :             :     }</span>
<span id="L84"><span class="lineNum">      84</span>                 :             : </span>
<span id="L85"><span class="lineNum">      85</span>                 :             :     /**</span>
<span id="L86"><span class="lineNum">      86</span>                 :             :     @notice Deposits collateral and borrows on behalf of the caller, buying the necessary DBR to pay for the loan over the period, by borrowing aditional funds to pay for the necessary DBR</span>
<span id="L87"><span class="lineNum">      87</span>                 :             :     @dev Has to borrow the dolaForDbr amount due to how the market's borrowOnBehalf functions, and repay the excess at the end of the call resulting in a weird repay event</span>
<span id="L88"><span class="lineNum">      88</span>                 :             :     @param market Market the caller wish to deposit to and borrow from</span>
<span id="L89"><span class="lineNum">      89</span>                 :             :     @param dolaAmount Amount the caller wants to end up with at their disposal</span>
<span id="L90"><span class="lineNum">      90</span>                 :             :     @param dolaForDbr The max amount of debt the caller is willing to take on to buy dbr</span>
<span id="L91"><span class="lineNum">      91</span>                 :             :      This is a sensitive parameter and should be reasonably low to prevent sandwhiching.</span>
<span id="L92"><span class="lineNum">      92</span>                 :             :      A good estimate can be calculated given the approximateDolaAndDbrNeeded function, though should be set slightly higher.</span>
<span id="L93"><span class="lineNum">      93</span>                 :             :     @param minDbr The minDbr the caller wish to borrow for</span>
<span id="L94"><span class="lineNum">      94</span>                 :             :     @param deadline Deadline of the signature</span>
<span id="L95"><span class="lineNum">      95</span>                 :             :     @param v V parameter of the signature</span>
<span id="L96"><span class="lineNum">      96</span>                 :             :     @param r R parameter of the signature</span>
<span id="L97"><span class="lineNum">      97</span>                 :             :     @param s S parameter of the signature</span>
<span id="L98"><span class="lineNum">      98</span>                 :             :     */</span>
<span id="L99"><span class="lineNum">      99</span>                 :<span class="tlaGNC">           1 :     function depositBuyDbrAndBorrowOnBehalf(</span></span>
<span id="L100"><span class="lineNum">     100</span>                 :             :         IMarket market, </span>
<span id="L101"><span class="lineNum">     101</span>                 :             :         uint collateralAmount, </span>
<span id="L102"><span class="lineNum">     102</span>                 :             :         uint dolaAmount,</span>
<span id="L103"><span class="lineNum">     103</span>                 :             :         uint dolaForDbr,</span>
<span id="L104"><span class="lineNum">     104</span>                 :             :         uint minDbr,</span>
<span id="L105"><span class="lineNum">     105</span>                 :             :         uint deadline, </span>
<span id="L106"><span class="lineNum">     106</span>                 :             :         uint8 v, </span>
<span id="L107"><span class="lineNum">     107</span>                 :             :         bytes32 r, </span>
<span id="L108"><span class="lineNum">     108</span>                 :             :         bytes32 s) </span>
<span id="L109"><span class="lineNum">     109</span>                 :             :         public </span>
<span id="L110"><span class="lineNum">     110</span>                 :             :     {</span>
<span id="L111"><span class="lineNum">     111</span>                 :<span class="tlaGNC">           1 :         IERC20 collateral = IERC20(market.collateral());</span></span>
<span id="L112"><span class="lineNum">     112</span>                 :             : </span>
<span id="L113"><span class="lineNum">     113</span>                 :             :         //Deposit collateral</span>
<span id="L114"><span class="lineNum">     114</span>                 :<span class="tlaGNC">           1 :         collateral.transferFrom(msg.sender, address(this), collateralAmount);</span></span>
<span id="L115"><span class="lineNum">     115</span>                 :<span class="tlaGNC">           1 :         collateral.approve(address(market), collateralAmount);</span></span>
<span id="L116"><span class="lineNum">     116</span>                 :<span class="tlaGNC">           1 :         market.deposit(msg.sender, collateralAmount);</span></span>
<span id="L117"><span class="lineNum">     117</span>                 :             : </span>
<span id="L118"><span class="lineNum">     118</span>                 :             :         //Borrow dola and buy dbr</span>
<span id="L119"><span class="lineNum">     119</span>                 :<span class="tlaGNC">           1 :         buyDbrAndBorrowOnBehalf(market, dolaAmount, dolaForDbr, minDbr, deadline, v, r , s);</span></span>
<span id="L120"><span class="lineNum">     120</span>                 :             :     }</span>
<span id="L121"><span class="lineNum">     121</span>                 :             : </span>
<span id="L122"><span class="lineNum">     122</span>                 :             :     /**</span>
<span id="L123"><span class="lineNum">     123</span>                 :             :     @notice Deposits native eth as collateral and borrows on behalf of the caller,</span>
<span id="L124"><span class="lineNum">     124</span>                 :             :     buying the necessary DBR to pay for the loan over the period, by borrowing aditional funds to pay for the necessary DBR</span>
<span id="L125"><span class="lineNum">     125</span>                 :             :     @dev Has to borrow the dolaForDbr amount due to how the market's borrowOnBehalf functions, and repay the excess at the end of the call resulting in a weird repay event</span>
<span id="L126"><span class="lineNum">     126</span>                 :             :     @param market Market the caller wish to deposit to and borrow from</span>
<span id="L127"><span class="lineNum">     127</span>                 :             :     @param dolaAmount Amount the caller wants to end up with at their disposal</span>
<span id="L128"><span class="lineNum">     128</span>                 :             :     @param dolaForDbr The max amount of debt the caller is willing to end up with</span>
<span id="L129"><span class="lineNum">     129</span>                 :             :      This is a sensitive parameter and should be reasonably low to prevent sandwhiching.</span>
<span id="L130"><span class="lineNum">     130</span>                 :             :      A good estimate can be calculated given the approximateDolaAndDbrNeeded function, though should be set slightly higher.</span>
<span id="L131"><span class="lineNum">     131</span>                 :             :     @param minDbr The minDbr the caller wish to borrow for</span>
<span id="L132"><span class="lineNum">     132</span>                 :             :     @param deadline Deadline of the signature</span>
<span id="L133"><span class="lineNum">     133</span>                 :             :     @param v V parameter of the signature</span>
<span id="L134"><span class="lineNum">     134</span>                 :             :     @param r R parameter of the signature</span>
<span id="L135"><span class="lineNum">     135</span>                 :             :     @param s S parameter of the signature</span>
<span id="L136"><span class="lineNum">     136</span>                 :             :     */</span>
<span id="L137"><span class="lineNum">     137</span>                 :<span class="tlaGNC">           1 :     function depositNativeEthBuyDbrAndBorrowOnBehalf(</span></span>
<span id="L138"><span class="lineNum">     138</span>                 :             :         IMarket market, </span>
<span id="L139"><span class="lineNum">     139</span>                 :             :         uint dolaAmount,</span>
<span id="L140"><span class="lineNum">     140</span>                 :             :         uint dolaForDbr,</span>
<span id="L141"><span class="lineNum">     141</span>                 :             :         uint minDbr,</span>
<span id="L142"><span class="lineNum">     142</span>                 :             :         uint deadline, </span>
<span id="L143"><span class="lineNum">     143</span>                 :             :         uint8 v, </span>
<span id="L144"><span class="lineNum">     144</span>                 :             :         bytes32 r, </span>
<span id="L145"><span class="lineNum">     145</span>                 :             :         bytes32 s) </span>
<span id="L146"><span class="lineNum">     146</span>                 :             :         public payable</span>
<span id="L147"><span class="lineNum">     147</span>                 :             :     {</span>
<span id="L148"><span class="lineNum">     148</span>                 :<span class="tlaGNC">           1 :         IERC20 collateral = IERC20(market.collateral());</span></span>
<span id="L149"><span class="lineNum">     149</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaGBC" title="Branch 1 was taken 1 time"> + </span>]:<span class="tlaGNC">           1 :         require(address(collateral) == address(WETH), &quot;Market is not an ETH market&quot;);</span></span>
<span id="L150"><span class="lineNum">     150</span>                 :<span class="tlaGNC">           1 :         WETH.deposit{value:msg.value}();</span></span>
<span id="L151"><span class="lineNum">     151</span>                 :             : </span>
<span id="L152"><span class="lineNum">     152</span>                 :             :         //Deposit collateral</span>
<span id="L153"><span class="lineNum">     153</span>                 :<span class="tlaGNC">           1 :         collateral.approve(address(market), msg.value);</span></span>
<span id="L154"><span class="lineNum">     154</span>                 :<span class="tlaGNC">           1 :         market.deposit(msg.sender, msg.value);</span></span>
<span id="L155"><span class="lineNum">     155</span>                 :             : </span>
<span id="L156"><span class="lineNum">     156</span>                 :             :         //Borrow dola and buy dbr</span>
<span id="L157"><span class="lineNum">     157</span>                 :<span class="tlaGNC">           1 :         buyDbrAndBorrowOnBehalf(market, dolaAmount, dolaForDbr, minDbr, deadline, v, r , s);</span></span>
<span id="L158"><span class="lineNum">     158</span>                 :             :     }</span>
<span id="L159"><span class="lineNum">     159</span>                 :             : </span>
<span id="L160"><span class="lineNum">     160</span>                 :             :     /**</span>
<span id="L161"><span class="lineNum">     161</span>                 :             :     @notice Sells DBR on behalf of the caller and uses the proceeds along with DOLA from the caller to repay debt.</span>
<span id="L162"><span class="lineNum">     162</span>                 :             :     @dev The caller is unlikely to spend all of the DOLA they make available for the function call</span>
<span id="L163"><span class="lineNum">     163</span>                 :             :     @param market The market the user wishes to repay debt in</span>
<span id="L164"><span class="lineNum">     164</span>                 :             :     @param dolaAmount The maximum amount of dola debt the user is willing to repay</span>
<span id="L165"><span class="lineNum">     165</span>                 :             :     @param minDolaFromDbr The minimum amount of DOLA the caller expects to get in return for selling their DBR.</span>
<span id="L166"><span class="lineNum">     166</span>                 :             :      This is a sensitive parameter and should be provided with reasonably low slippage to prevent sandwhiching.</span>
<span id="L167"><span class="lineNum">     167</span>                 :             :     @param dbrAmountToSell The amount of DBR the caller wishes to sell</span>
<span id="L168"><span class="lineNum">     168</span>                 :             :     */</span>
<span id="L169"><span class="lineNum">     169</span>                 :<span class="tlaGNC">           1 :     function sellDbrAndRepayOnBehalf(IMarket market, uint dolaAmount, uint minDolaFromDbr, uint dbrAmountToSell) public {</span></span>
<span id="L170"><span class="lineNum">     170</span>                 :<span class="tlaGNC">           3 :         uint dbrBal = DBR.balanceOf(msg.sender);</span></span>
<span id="L171"><span class="lineNum">     171</span>                 :             : </span>
<span id="L172"><span class="lineNum">     172</span>                 :             :         //If user has less DBR than ordered, sell what's available</span>
<span id="L173"><span class="lineNum">     173</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaUNC" title="Branch 1 was not executed"> # </span>]:<span class="tlaGNC">           3 :         if(dbrAmountToSell &gt; dbrBal){</span></span>
<span id="L174"><span class="lineNum">     174</span>                 :<span class="tlaUNC tlaBgUNC">           0 :             DBR.transferFrom(msg.sender, address(this), dbrBal);</span></span>
<span id="L175"><span class="lineNum">     175</span>                 :<span class="tlaUNC">           0 :             _sellDbr(dbrBal, minDolaFromDbr);</span></span>
<span id="L176"><span class="lineNum">     176</span>                 :             :         } else {</span>
<span id="L177"><span class="lineNum">     177</span>                 :<span class="tlaGNC tlaBgGNC">           3 :             DBR.transferFrom(msg.sender, address(this), dbrAmountToSell);</span></span>
<span id="L178"><span class="lineNum">     178</span>                 :<span class="tlaGNC">           3 :             _sellDbr(dbrAmountToSell, minDolaFromDbr);</span></span>
<span id="L179"><span class="lineNum">     179</span>                 :             :         }</span>
<span id="L180"><span class="lineNum">     180</span>                 :             : </span>
<span id="L181"><span class="lineNum">     181</span>                 :<span class="tlaGNC">           3 :         uint debt = market.debts(msg.sender);</span></span>
<span id="L182"><span class="lineNum">     182</span>                 :<span class="tlaGNC">           3 :         uint dolaBal = DOLA.balanceOf(address(this));</span></span>
<span id="L183"><span class="lineNum">     183</span>                 :             :         </span>
<span id="L184"><span class="lineNum">     184</span>                 :             :         //If the debt is lower than the dolaAmount, repay debt else repay dolaAmount</span>
<span id="L185"><span class="lineNum">     185</span>                 :<span class="tlaGNC">           3 :         uint repayAmount = debt &lt; dolaAmount ? debt : dolaAmount;</span></span>
<span id="L186"><span class="lineNum">     186</span>                 :             : </span>
<span id="L187"><span class="lineNum">     187</span>                 :             :         //If dolaBal is less than repayAmount, transfer remaining DOLA from user, otherwise transfer excess dola to user</span>
<span id="L188"><span class="lineNum">     188</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaGBC" title="Branch 1 was taken 3 times"> + </span>]:<span class="tlaGNC">           3 :         if(dolaBal &lt; repayAmount){</span></span>
<span id="L189"><span class="lineNum">     189</span>                 :<span class="tlaGNC">           3 :             DOLA.transferFrom(msg.sender, address(this), repayAmount - dolaBal);</span></span>
<span id="L190"><span class="lineNum">     190</span>                 :             :         } else {</span>
<span id="L191"><span class="lineNum">     191</span>                 :<span class="tlaUNC tlaBgUNC">           0 :             DOLA.transfer(msg.sender, dolaBal - repayAmount);</span></span>
<span id="L192"><span class="lineNum">     192</span>                 :             :         }</span>
<span id="L193"><span class="lineNum">     193</span>                 :             : </span>
<span id="L194"><span class="lineNum">     194</span>                 :             :         //Repay repayAmount</span>
<span id="L195"><span class="lineNum">     195</span>                 :<span class="tlaGNC tlaBgGNC">           3 :         DOLA.approve(address(market), repayAmount);</span></span>
<span id="L196"><span class="lineNum">     196</span>                 :<span class="tlaGNC">           3 :         market.repay(msg.sender, repayAmount);</span></span>
<span id="L197"><span class="lineNum">     197</span>                 :             :     }</span>
<span id="L198"><span class="lineNum">     198</span>                 :             : </span>
<span id="L199"><span class="lineNum">     199</span>                 :             :     /**</span>
<span id="L200"><span class="lineNum">     200</span>                 :             :     @notice Sells DBR on behalf of the caller and uses the proceeds along with DOLA from the caller to repay debt, and then withdraws collateral</span>
<span id="L201"><span class="lineNum">     201</span>                 :             :     @dev The caller is unlikely to spend all of the DOLA they make available for the function call</span>
<span id="L202"><span class="lineNum">     202</span>                 :             :     @param market Market the user wishes to repay debt in</span>
<span id="L203"><span class="lineNum">     203</span>                 :             :     @param dolaAmount Maximum amount of dola debt the user is willing to repay</span>
<span id="L204"><span class="lineNum">     204</span>                 :             :     @param minDolaFromDbr Minimum amount of DOLA the caller expects to get in return for selling their DBR</span>
<span id="L205"><span class="lineNum">     205</span>                 :             :      This is a sensitive parameter and should be provided with reasonably low slippage to prevent sandwhiching.</span>
<span id="L206"><span class="lineNum">     206</span>                 :             :     @param dbrAmountToSell Amount of DBR the caller wishes to sell</span>
<span id="L207"><span class="lineNum">     207</span>                 :             :     @param collateralAmount Amount of collateral to withdraw</span>
<span id="L208"><span class="lineNum">     208</span>                 :             :     @param deadline Deadline of the signature</span>
<span id="L209"><span class="lineNum">     209</span>                 :             :     @param v V parameter of the signature</span>
<span id="L210"><span class="lineNum">     210</span>                 :             :     @param r R parameter of the signature</span>
<span id="L211"><span class="lineNum">     211</span>                 :             :     @param s S parameter of the signature</span>
<span id="L212"><span class="lineNum">     212</span>                 :             :     */</span>
<span id="L213"><span class="lineNum">     213</span>                 :<span class="tlaGNC">           1 :     function sellDbrRepayAndWithdrawOnBehalf(</span></span>
<span id="L214"><span class="lineNum">     214</span>                 :             :         IMarket market, </span>
<span id="L215"><span class="lineNum">     215</span>                 :             :         uint dolaAmount, </span>
<span id="L216"><span class="lineNum">     216</span>                 :             :         uint minDolaFromDbr,</span>
<span id="L217"><span class="lineNum">     217</span>                 :             :         uint dbrAmountToSell, </span>
<span id="L218"><span class="lineNum">     218</span>                 :             :         uint collateralAmount, </span>
<span id="L219"><span class="lineNum">     219</span>                 :             :         uint deadline, </span>
<span id="L220"><span class="lineNum">     220</span>                 :             :         uint8 v, </span>
<span id="L221"><span class="lineNum">     221</span>                 :             :         bytes32 r, </span>
<span id="L222"><span class="lineNum">     222</span>                 :             :         bytes32 s) </span>
<span id="L223"><span class="lineNum">     223</span>                 :             :         external </span>
<span id="L224"><span class="lineNum">     224</span>                 :             :     {</span>
<span id="L225"><span class="lineNum">     225</span>                 :             :         //Repay</span>
<span id="L226"><span class="lineNum">     226</span>                 :<span class="tlaGNC">           1 :         sellDbrAndRepayOnBehalf(market, dolaAmount, minDolaFromDbr, dbrAmountToSell);</span></span>
<span id="L227"><span class="lineNum">     227</span>                 :             : </span>
<span id="L228"><span class="lineNum">     228</span>                 :             :         //Withdraw</span>
<span id="L229"><span class="lineNum">     229</span>                 :<span class="tlaGNC">           1 :         market.withdrawOnBehalf(msg.sender, collateralAmount, deadline, v, r, s);</span></span>
<span id="L230"><span class="lineNum">     230</span>                 :             : </span>
<span id="L231"><span class="lineNum">     231</span>                 :             :         //Transfer collateral to msg.sender</span>
<span id="L232"><span class="lineNum">     232</span>                 :<span class="tlaGNC">           1 :         IERC20(market.collateral()).transfer(msg.sender, collateralAmount);</span></span>
<span id="L233"><span class="lineNum">     233</span>                 :             :     }</span>
<span id="L234"><span class="lineNum">     234</span>                 :             : </span>
<span id="L235"><span class="lineNum">     235</span>                 :             :     /**</span>
<span id="L236"><span class="lineNum">     236</span>                 :             :     @notice Sells DBR on behalf of the caller and uses the proceeds along with DOLA from the caller to repay debt, and then withdraws collateral</span>
<span id="L237"><span class="lineNum">     237</span>                 :             :     @dev The caller is unlikely to spend all of the DOLA they make available for the function call</span>
<span id="L238"><span class="lineNum">     238</span>                 :             :     @param market Market the user wishes to repay debt in</span>
<span id="L239"><span class="lineNum">     239</span>                 :             :     @param dolaAmount Maximum amount of dola debt the user is willing to repay</span>
<span id="L240"><span class="lineNum">     240</span>                 :             :     @param minDolaFromDbr Minimum amount of DOLA the caller expects to get in return for selling their DBR</span>
<span id="L241"><span class="lineNum">     241</span>                 :             :      This is a sensitive parameter and should be provided with reasonably low slippage to prevent sandwhiching.</span>
<span id="L242"><span class="lineNum">     242</span>                 :             :     @param dbrAmountToSell Amount of DBR the caller wishes to sell</span>
<span id="L243"><span class="lineNum">     243</span>                 :             :     @param collateralAmount Amount of collateral to withdraw</span>
<span id="L244"><span class="lineNum">     244</span>                 :             :     @param deadline Deadline of the signature</span>
<span id="L245"><span class="lineNum">     245</span>                 :             :     @param v V parameter of the signature</span>
<span id="L246"><span class="lineNum">     246</span>                 :             :     @param r R parameter of the signature</span>
<span id="L247"><span class="lineNum">     247</span>                 :             :     @param s S parameter of the signature</span>
<span id="L248"><span class="lineNum">     248</span>                 :             :     */</span>
<span id="L249"><span class="lineNum">     249</span>                 :<span class="tlaGNC">           1 :     function sellDbrRepayAndWithdrawNativeEthOnBehalf(</span></span>
<span id="L250"><span class="lineNum">     250</span>                 :             :         IMarket market, </span>
<span id="L251"><span class="lineNum">     251</span>                 :             :         uint dolaAmount, </span>
<span id="L252"><span class="lineNum">     252</span>                 :             :         uint minDolaFromDbr,</span>
<span id="L253"><span class="lineNum">     253</span>                 :             :         uint dbrAmountToSell, </span>
<span id="L254"><span class="lineNum">     254</span>                 :             :         uint collateralAmount, </span>
<span id="L255"><span class="lineNum">     255</span>                 :             :         uint deadline, </span>
<span id="L256"><span class="lineNum">     256</span>                 :             :         uint8 v, </span>
<span id="L257"><span class="lineNum">     257</span>                 :             :         bytes32 r, </span>
<span id="L258"><span class="lineNum">     258</span>                 :             :         bytes32 s) </span>
<span id="L259"><span class="lineNum">     259</span>                 :             :         external </span>
<span id="L260"><span class="lineNum">     260</span>                 :             :     {</span>
<span id="L261"><span class="lineNum">     261</span>                 :             :         //Repay</span>
<span id="L262"><span class="lineNum">     262</span>                 :<span class="tlaGNC">           1 :         sellDbrAndRepayOnBehalf(market, dolaAmount, minDolaFromDbr, dbrAmountToSell);</span></span>
<span id="L263"><span class="lineNum">     263</span>                 :             : </span>
<span id="L264"><span class="lineNum">     264</span>                 :             :         //Withdraw</span>
<span id="L265"><span class="lineNum">     265</span>                 :<span class="tlaGNC">           1 :         withdrawNativeEthOnBehalf(market, collateralAmount, deadline, v, r, s);</span></span>
<span id="L266"><span class="lineNum">     266</span>                 :             :     }</span>
<span id="L267"><span class="lineNum">     267</span>                 :             : </span>
<span id="L268"><span class="lineNum">     268</span>                 :             :     /**</span>
<span id="L269"><span class="lineNum">     269</span>                 :             :     @notice Repays debt, and then withdraws native ETH</span>
<span id="L270"><span class="lineNum">     270</span>                 :             :     @dev The caller is unlikely to spend all of the DOLA they make available for the function call</span>
<span id="L271"><span class="lineNum">     271</span>                 :             :     @param market Market the user wishes to repay debt in</span>
<span id="L272"><span class="lineNum">     272</span>                 :             :     @param dolaAmount Amount of dola debt the user is willing to repay    </span>
<span id="L273"><span class="lineNum">     273</span>                 :             :     @param collateralAmount Amount of collateral to withdraw</span>
<span id="L274"><span class="lineNum">     274</span>                 :             :     @param deadline Deadline of the signature</span>
<span id="L275"><span class="lineNum">     275</span>                 :             :     @param v V parameter of the signature</span>
<span id="L276"><span class="lineNum">     276</span>                 :             :     @param r R parameter of the signature</span>
<span id="L277"><span class="lineNum">     277</span>                 :             :     @param s S parameter of the signature</span>
<span id="L278"><span class="lineNum">     278</span>                 :             :     */</span>
<span id="L279"><span class="lineNum">     279</span>                 :<span class="tlaGNC">           1 :     function repayAndWithdrawNativeEthOnBehalf(</span></span>
<span id="L280"><span class="lineNum">     280</span>                 :             :         IMarket market, </span>
<span id="L281"><span class="lineNum">     281</span>                 :             :         uint dolaAmount,                 </span>
<span id="L282"><span class="lineNum">     282</span>                 :             :         uint collateralAmount, </span>
<span id="L283"><span class="lineNum">     283</span>                 :             :         uint deadline,</span>
<span id="L284"><span class="lineNum">     284</span>                 :             :         uint8 v, </span>
<span id="L285"><span class="lineNum">     285</span>                 :             :         bytes32 r, </span>
<span id="L286"><span class="lineNum">     286</span>                 :             :         bytes32 s) </span>
<span id="L287"><span class="lineNum">     287</span>                 :             :         external </span>
<span id="L288"><span class="lineNum">     288</span>                 :             :     {        </span>
<span id="L289"><span class="lineNum">     289</span>                 :             :         // Repay</span>
<span id="L290"><span class="lineNum">     290</span>                 :<span class="tlaGNC">           1 :         DOLA.transferFrom(msg.sender, address(this), dolaAmount);        </span></span>
<span id="L291"><span class="lineNum">     291</span>                 :<span class="tlaGNC">           1 :         DOLA.approve(address(market), dolaAmount);</span></span>
<span id="L292"><span class="lineNum">     292</span>                 :<span class="tlaGNC">           1 :         market.repay(msg.sender, dolaAmount);</span></span>
<span id="L293"><span class="lineNum">     293</span>                 :             : </span>
<span id="L294"><span class="lineNum">     294</span>                 :             :         // Withdraw</span>
<span id="L295"><span class="lineNum">     295</span>                 :<span class="tlaGNC">           1 :         withdrawNativeEthOnBehalf(market, collateralAmount, deadline, v, r, s);</span></span>
<span id="L296"><span class="lineNum">     296</span>                 :             :     }</span>
<span id="L297"><span class="lineNum">     297</span>                 :             : </span>
<span id="L298"><span class="lineNum">     298</span>                 :             :     /**</span>
<span id="L299"><span class="lineNum">     299</span>                 :             :     @notice Helper function for depositing native eth to WETH markets</span>
<span id="L300"><span class="lineNum">     300</span>                 :             :     @param market The WETH market to deposit to</span>
<span id="L301"><span class="lineNum">     301</span>                 :             :     */</span>
<span id="L302"><span class="lineNum">     302</span>                 :<span class="tlaGNC">           1 :     function depositNativeEthOnBehalf(IMarket market) public payable {</span></span>
<span id="L303"><span class="lineNum">     303</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaGBC" title="Branch 1 was taken 1 time"> + </span>]:<span class="tlaGNC">           1 :         require(address(market.collateral()) == address(WETH), &quot;Not an ETH market&quot;);</span></span>
<span id="L304"><span class="lineNum">     304</span>                 :<span class="tlaGNC">           1 :         WETH.deposit{value:msg.value}();</span></span>
<span id="L305"><span class="lineNum">     305</span>                 :<span class="tlaGNC">           1 :         WETH.approve(address(market), msg.value);</span></span>
<span id="L306"><span class="lineNum">     306</span>                 :<span class="tlaGNC">           1 :         market.deposit(msg.sender, msg.value);</span></span>
<span id="L307"><span class="lineNum">     307</span>                 :             :     }</span>
<span id="L308"><span class="lineNum">     308</span>                 :             : </span>
<span id="L309"><span class="lineNum">     309</span>                 :             :     /**</span>
<span id="L310"><span class="lineNum">     310</span>                 :             :     @notice Helper function for depositing native eth to WETH markets before borrowing on behalf of the depositor</span>
<span id="L311"><span class="lineNum">     311</span>                 :             :     @param market The WETH market to deposit to</span>
<span id="L312"><span class="lineNum">     312</span>                 :             :     @param borrowAmount The amount to borrow on behalf of the depositor</span>
<span id="L313"><span class="lineNum">     313</span>                 :             :     @param deadline Deadline of the signature</span>
<span id="L314"><span class="lineNum">     314</span>                 :             :     @param v V parameter of the signature</span>
<span id="L315"><span class="lineNum">     315</span>                 :             :     @param r R parameter of the signature</span>
<span id="L316"><span class="lineNum">     316</span>                 :             :     @param s S parameter of the signature</span>
<span id="L317"><span class="lineNum">     317</span>                 :             :     */</span>
<span id="L318"><span class="lineNum">     318</span>                 :<span class="tlaGNC">           1 :     function depositNativeEthAndBorrowOnBehalf(IMarket market, uint borrowAmount, uint deadline, uint8 v, bytes32 r, bytes32 s) public payable {</span></span>
<span id="L319"><span class="lineNum">     319</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaGBC" title="Branch 1 was taken 1 time"> + </span>]:<span class="tlaGNC">           1 :         require(address(market.collateral()) == address(WETH), &quot;Not an ETH market&quot;);</span></span>
<span id="L320"><span class="lineNum">     320</span>                 :             : </span>
<span id="L321"><span class="lineNum">     321</span>                 :             :         //Deposit native eth</span>
<span id="L322"><span class="lineNum">     322</span>                 :<span class="tlaGNC">           1 :         WETH.deposit{value:msg.value}();</span></span>
<span id="L323"><span class="lineNum">     323</span>                 :<span class="tlaGNC">           1 :         WETH.approve(address(market), msg.value);</span></span>
<span id="L324"><span class="lineNum">     324</span>                 :<span class="tlaGNC">           1 :         market.deposit(msg.sender, msg.value);</span></span>
<span id="L325"><span class="lineNum">     325</span>                 :             : </span>
<span id="L326"><span class="lineNum">     326</span>                 :             :         //Borrow Dola</span>
<span id="L327"><span class="lineNum">     327</span>                 :<span class="tlaGNC">           1 :         market.borrowOnBehalf(msg.sender, borrowAmount, deadline, v, r, s);</span></span>
<span id="L328"><span class="lineNum">     328</span>                 :<span class="tlaGNC">           1 :         DOLA.transfer(msg.sender, borrowAmount);</span></span>
<span id="L329"><span class="lineNum">     329</span>                 :             :     }</span>
<span id="L330"><span class="lineNum">     330</span>                 :             : </span>
<span id="L331"><span class="lineNum">     331</span>                 :             :     /**</span>
<span id="L332"><span class="lineNum">     332</span>                 :             :     @notice Helper function for withdrawing to native eth</span>
<span id="L333"><span class="lineNum">     333</span>                 :             :     @param market WETH market to withdraw collateral from</span>
<span id="L334"><span class="lineNum">     334</span>                 :             :     @param collateralAmount Amount of collateral to withdraw</span>
<span id="L335"><span class="lineNum">     335</span>                 :             :     @param deadline Deadline of the signature</span>
<span id="L336"><span class="lineNum">     336</span>                 :             :     @param v V parameter of the signature</span>
<span id="L337"><span class="lineNum">     337</span>                 :             :     @param r R parameter of the signature</span>
<span id="L338"><span class="lineNum">     338</span>                 :             :     @param s S parameter of the signature</span>
<span id="L339"><span class="lineNum">     339</span>                 :             :     */</span>
<span id="L340"><span class="lineNum">     340</span>                 :<span class="tlaGNC">           1 :     function withdrawNativeEthOnBehalf(</span></span>
<span id="L341"><span class="lineNum">     341</span>                 :             :         IMarket market,</span>
<span id="L342"><span class="lineNum">     342</span>                 :             :         uint collateralAmount,</span>
<span id="L343"><span class="lineNum">     343</span>                 :             :         uint deadline,</span>
<span id="L344"><span class="lineNum">     344</span>                 :             :         uint8 v,</span>
<span id="L345"><span class="lineNum">     345</span>                 :             :         bytes32 r,</span>
<span id="L346"><span class="lineNum">     346</span>                 :             :         bytes32 s)</span>
<span id="L347"><span class="lineNum">     347</span>                 :             :         public</span>
<span id="L348"><span class="lineNum">     348</span>                 :             :     {</span>
<span id="L349"><span class="lineNum">     349</span>                 :<span class="tlaGNC">           3 :         market.withdrawOnBehalf(msg.sender, collateralAmount, deadline, v, r, s);</span></span>
<span id="L350"><span class="lineNum">     350</span>                 :             : </span>
<span id="L351"><span class="lineNum">     351</span>                 :<span class="tlaGNC">           3 :         IERC20 collateral = IERC20(market.collateral());</span></span>
<span id="L352"><span class="lineNum">     352</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaGBC" title="Branch 1 was taken 3 times"> + </span>]:<span class="tlaGNC">           3 :         require(address(collateral) == address(WETH), &quot;Not an ETH market&quot;);</span></span>
<span id="L353"><span class="lineNum">     353</span>                 :<span class="tlaGNC">           3 :         WETH.withdraw(collateralAmount);</span></span>
<span id="L354"><span class="lineNum">     354</span>                 :             : </span>
<span id="L355"><span class="lineNum">     355</span>                 :<span class="tlaGNC">           3 :         (bool success,) = payable(msg.sender).call{value:collateralAmount}(&quot;&quot;);</span></span>
<span id="L356"><span class="lineNum">     356</span>         [<span class="tlaUNC" title="Branch 0 was not executed"> # </span><span class="tlaGBC" title="Branch 1 was taken 3 times"> + </span>]:<span class="tlaGNC">           3 :         require(success, &quot;Failed to transfer ETH&quot;);</span></span>
<span id="L357"><span class="lineNum">     357</span>                 :             :     }</span>
<span id="L358"><span class="lineNum">     358</span>                 :             :     </span>
<span id="L359"><span class="lineNum">     359</span>                 :             :     //Empty receive function for receiving the native eth sent by the WETH contract</span>
<span id="L360"><span class="lineNum">     360</span>                 :             :     receive() external payable {}</span>
<span id="L361"><span class="lineNum">     361</span>                 :             : }</span>
        </pre>
              </td>
            </tr>
          </table>
          <br>

          <table width="100%" border=0 cellspacing=0 cellpadding=0>
            <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
            <tr><td class="versionInfo">Generated by: <a href="https://github.com//linux-test-project/lcov" target="_parent">LCOV version 2.0-1</a></td></tr>
          </table>
          <br>

</body>
</html>
